<?xml version="1.0" encoding="UTF-8"?>
<project name="module" basedir="." default="all">
    <!-- properties -->
    <property environment="env" />
    <property name="author" value="Garfield" />
    <property name="version" value="1.4.0" />
    <property name="ndk.module" value="funshion" />
    <property name="ndk.package" value="com/funshion" />
    <property name="java.package" value="com.funshion" />
    <property name="jar.file.name" value="${ndk.module}.jar" />
    <property name="source.file.name" value="${ndk.module}-sources.jar" />
    <property name="ndk.args" value="-B all=1 LOCAL_MODULE_NAME=${ndk.module} PACKAGE_GRAPHICS=${ndk.package}/graphics/ PACKAGE_UTILITIES=${ndk.package}/util/" />
    <!-- <property name="ndk.args" value="-B NDK_STL=1 all=1 LOCAL_MODULE_NAME=${ndk.module} PACKAGE_GRAPHICS=${ndk.package}/graphics/ PACKAGE_UTILITIES=${ndk.package}/util/" /> -->

    <property name="src.dir" value="${basedir}/src" />
    <property name="out.dir" value="${basedir}/out" />
    <property name="class.dir" value="${basedir}/classes" />

    <property name="api.level" value="22" />
    <property name="sdk.dir" value="${env.ANDROID_HOME}" />
    <property name="sdk.version" value="Android 5.1.1 (API ${api.level})" />
    <property name="library.jars.dir" value="E:\Include\java" />
    <property name="zxing.jar.path" value="${library.jars.dir}/zxing/zxing.jar" />
    <property name="android.jar.path" value="${sdk.dir}/platforms/android-${api.level}/android.jar" />
    <property name="android.internal.jar.path" value="${library.jars.dir}/android/android-sdk-internal.jar" />
    <property name="recyclerview.v7.jar.path" value="${library.jars.dir}/recyclerview/recyclerview-v7.jar" />
    <property name="support.v4.jar.path" value="${sdk.dir}/extras/android/support/v7/appcompat/libs/android-support-v4.jar" />

    <condition property="compile.barcode">
        <istrue value="true"/>
    </condition>

    <!-- target -copy -->
    <target name="-copy">
        <!-- copy the java files -->
        <copy todir="${src.dir}/${ndk.package}" overwrite="true">
            <fileset dir="${basedir}/../src/android/ext">
                <exclude name="**/temp/**" />
                <exclude name="**/reference/**" />
                <exclude name="**/graphics/ShapeLayer.java" />
                <exclude name="**/graphics/OutlineUtils.java" />
                <exclude name="**/service/SyncService.java" />
                <exclude name="**/service/SyncMessenger.java" />
                <exclude name="**/widget/FocusViewPager.java" />
                <exclude name="**/widget/ExpandableCursorAdapter.java" />
                <exclude name="**/widget/ExpandableCursorTreeAdapter.java" />
            </fileset>
        </copy>

        <!-- copy the android support v7 files -->
        <copy todir="${src.dir}/android/support/v7" overwrite="true">
            <fileset dir="${basedir}/../src/android/support/v7" />
        </copy>

        <!-- replace the package name -->
        <replace dir="${src.dir}" includes="**/*.java" encoding="UTF-8">
            <replacefilter token="@author Garfield" value="@author ${author}" />
            <replacefilter token="android.ext" value="${java.package}" />
        </replace>
    </target>

    <!-- target -remove-barcode-if -->
    <target name="-remove-barcode-if" unless="compile.barcode">
        <echo level="info">Remove barcode source files...</echo>
        <delete dir="${src.dir}/${ndk.package}/barcode"/>
    </target>

    <!-- target -delete-debug-call -->
    <target name="-delete-debug-call">
        <!-- delete call the __checkXXX methods -->
        <echo level="info">Delete __checkXXX() methods call</echo>
        <replaceregexp match="(.*)__check(.*);" replace="" flags="g" byline="true" >
            <fileset dir="${src.dir}" includes="**/*.java" />
        </replaceregexp>
    </target>

    <!-- target -replace-release-call -->
    <target name="-replace-release-call">
        <!-- replace call writeUncaughtException() to storeUncaughtException() method -->
        <echo level="info">Replace writeUncaughtException() to storeUncaughtException() in the ProcessUtils.java</echo>
        <replace dir="${src.dir}" includes="**/ProcessUtils.java" encoding="UTF-8">
            <replacefilter token="this.writeUncaughtException" value="this.storeUncaughtException" />
        </replace>
    </target>

    <!-- target -pre-compile-debug -->
    <target name="-pre-compile-debug">
        <property name="ndk.debug" value="1" />
        <property name="file.out.dir" value="${out.dir}/debug" />
        <echo level="info">Builds the ${ndk.module} module in DEBUG mode.</echo>
        <echo level="info">ndk-build NDK_DEBUG=${ndk.debug} ${ndk.args}</echo>
    </target>

    <!-- target -pre-compile-release -->
    <target name="-pre-compile-release">
        <property name="ndk.debug" value="0" />
        <property name="file.out.dir" value="${out.dir}/release" />
        <echo level="info">Builds the ${ndk.module} module in RELEASE mode.</echo>
        <echo level="info">ndk-build NDK_DEBUG=${ndk.debug} ${ndk.args}</echo>
    </target>

    <!-- target -compile-jar -->
    <target name="-compile-jar">
        <!-- compile java files -->
        <mkdir dir="${class.dir}" />
        <javac srcdir="${src.dir}" destdir="${class.dir}" debug="true" source="1.7" target="1.7" includeAntRuntime="false" includeJavaRuntime="false"
            classpath="${android.internal.jar.path};${android.jar.path};${support.v4.jar.path};${recyclerview.v7.jar.path};${zxing.jar.path}" />

        <!-- build jar file -->
        <jar destfile="${file.out.dir}/${jar.file.name}" basedir="${class.dir}">
            <manifest>
                <attribute name="Built-By" value="${author}" />
                <attribute name="Version" value="${version}" />
                <attribute name="SDK-Version" value="${sdk.version}" />
            </manifest>
        </jar>

        <!-- build source jar file -->
        <jar destfile="${file.out.dir}/${source.file.name}" basedir="${src.dir}">
            <manifest>
                <attribute name="Built-By" value="${author}" />
                <attribute name="Version" value="${version}" />
                <attribute name="SDK-Version" value="${sdk.version}" />
            </manifest>
        </jar>
    </target>

    <!-- target -compile-so -->
    <target name="-compile-so">
        <!-- compile c++ files -->
        <exec executable="cmd.exe">
            <arg line="/C ndk-build NDK_DEBUG=${ndk.debug} ${ndk.args}" />
        </exec>

        <!-- copy so file -->
        <copy todir="${file.out.dir}" overwrite="true">
            <fileset dir="${basedir}/../libs" />
        </copy>

        <!-- delete obj, libs files -->
        <delete dir="${basedir}/../obj" />
        <delete dir="${basedir}/../libs" />
    </target>

    <!-- +++++++++++++++++++++++++++++++++ optional ant task +++++++++++++++++++++++++++++++++ -->
    <!-- target -obfuscate -->
    <target name="-obfuscate">
        <!-- add proguard tasks -->
        <property name="proguard.dir" value="${sdk.dir}/tools/proguard" />
        <taskdef name="proguard" classname="proguard.ant.ProGuardTask" classpath="${proguard.dir}/lib/proguard.jar" />

        <!-- build jar file -->
        <jar destfile="${file.out.dir}/${jar.file.name}" basedir="${class.dir}" />

        <proguard>
            -include        "${basedir}/../proguard.txt"
            -injars         ${file.out.dir}/${jar.file.name}
            -outjars        "${file.out.dir}/${jar.file.name}"
            -libraryjars    ${android.jar.path};${support.v4.jar.path};${recyclerview.v7.jar.path};${zxing.jar.path}
            -dump           "${file.out.dir}/dump.txt"
            -printseeds     "${file.out.dir}/seeds.txt"
            -printusage     "${file.out.dir}/usage.txt"
            -printmapping   "${file.out.dir}/mapping.txt"
        </proguard>
    </target>

    <!-- target -compile-dex -->
    <target name="-compile-dex">
        <property name="dx.dir" value="${sdk.dir}/build-tools/25.0.3" />
        <property name="out.dex.file" value="${file.out.dir}/${ndk.module}-dex.jar" />

        <!-- compile dex file -->
        <echo level="info">dx --dex --output=${ndk.module}-dex.jar ${jar.file.name}</echo>
        <exec executable="cmd.exe">
            <arg line="/C ${dx.dir}/dx.bat --dex --output=${out.dex.file} ${file.out.dir}/${jar.file.name}" />
        </exec>
    </target>
    <!-- +++++++++++++++++++++++++++++++++ optional ant task +++++++++++++++++++++++++++++++++ -->

    <!-- target -post-compile -->
    <target name="-post-compile">
        <copy file="${basedir}/../res/values/attrs_widget.xml" tofile="${out.dir}/attrs_widget.xml" />
        <copy file="${basedir}/../jni/proguard.txt" tofile="${out.dir}/${ndk.module}-proguard.txt" />
        <echo level="info">Deletes temp files...</echo>
        <delete includeemptydirs="true">
            <fileset dir="${basedir}">
                <exclude name="build.xml" />
                <exclude name="**/out/**" />
            </fileset>
        </delete>

        <echo level="info">Install: ${file.out.dir}/${jar.file.name}</echo>
        <echo level="info">Install: ${out.dir}/attrs_widget.xml</echo>
        <echo level="info">Install: ${out.dir}/${ndk.module}-proguard.txt</echo>
    </target>

    <!-- target -clean -->
    <target name="-clean">
        <echo level="info">Deletes output files...</echo>
        <delete dir="${file.out.dir}"/>
    </target>

    <!-- target test -->
    <target name="test" depends="-clean, -copy, -remove-barcode-if, -pre-compile-release, -delete-debug-call, -replace-release-call, -compile-jar, -post-compile" />

    <!-- target debug -->
    <target name="debug" depends="-clean, -copy, -remove-barcode-if, -pre-compile-debug, -compile-jar, -compile-so, -post-compile" />

    <!-- target release -->
    <target name="release" depends="-clean, -copy, -remove-barcode-if, -pre-compile-release, -delete-debug-call, -replace-release-call, -compile-jar, -compile-so, -post-compile" />

    <!-- target all -->
    <target name="all">
        <antcall target="debug" />
        <antcall target="release" />
    </target>
</project>
