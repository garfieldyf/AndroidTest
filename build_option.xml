<?xml version="1.0" encoding="UTF-8"?>
<project name="option" default="" basedir=".">
    <!-- compilation options -->
    <property name="java.source" value="1.7" />
    <property name="java.target" value="1.7" />
    <property name="libs.jar.dir" value="E:/Include/java" />

    <!-- pre-build target -->
    <target name="-pre-build">
        <!-- clean bin and gen dir -->
        <delete dir="${out.absolute.dir}" verbose="${verbose}" />
        <delete dir="${gen.absolute.dir}" verbose="${verbose}" />

        <!-- modify AndroidManifest.xml versionCode, versionName -->
        <echo message="versionCode : ${version.code}" />
        <echo message="versionName : ${version.name}" />
        <replaceregexp file="${manifest.abs.file}" match="\bandroid:versionCode=&quot;.*&quot;" replace="android:versionCode=&quot;${version.code}&quot;" byline="false" encoding="utf-8" />
        <replaceregexp file="${manifest.abs.file}" match="\bandroid:versionName=&quot;.*&quot;" replace="android:versionName=&quot;${version.name}&quot;" byline="false" encoding="utf-8" />

        <!-- modify DEBUG, BRAND in DeviceInfo.java
        <property name="build.debug" value="DEBUG = true;" />
        <property name="build.brand" value="BRAND = &quot;xiaomi&quot;;" />
        <replaceregexp file="${source.dir}/com/xxx/test/DeviceInfo.java" match="\bDEBUG\s*=.*;" replace="${build.debug}" byline="false" encoding="utf-8" />
        <replaceregexp file="${source.dir}/com/xxx/test/DeviceInfo.java" match="\bBRAND\s*=.*;" replace="${build.brand}" byline="false" encoding="utf-8" />
        -->
    </target>

    <!-- debug output filename -->
    <target name="-rename-debug-out-file">
        <property name="out.file.dir" value="debug" />
        <property name="out.file.name" value="${ant.project.name}_v${version.name}_debug.apk" />
        <property name="out.final.file" location="${out.absolute.dir}/${out.file.name}" />
        <property name="funshion.libs.dir" value="${basedir}/funshion/debug" />
    </target>

    <target name="-set-debug-files" depends="-rename-debug-out-file, android_rules.-set-debug-files" />

    <!-- release output filename -->
    <target name="-rename-release-out-file">
        <property name="out.file.dir" value="release" />
        <property name="out.file.name" value="${ant.project.name}_v${version.name}_release.apk" />
        <property name="out.final.file" location="${out.absolute.dir}/${out.file.name}" />
        <property name="funshion.libs.dir" value="${basedir}/funshion/release" />
    </target>

    <target name="-set-release-mode" depends="-rename-release-out-file, android_rules.-set-release-mode" />

    <!-- include jars -->
    <target name="-pre-compile"> 
        <!-- copy so files -->
        <echo message="Copy libs from ${funshion.libs.dir} to ${jar.libs.dir}" />
        <copy todir="${jar.libs.dir}" overwrite="true">
            <fileset dir="${funshion.libs.dir}" excludes="**/*.jar" />
        </copy>

        <path id="zxing.jar.path">
            <path path="${toString:project.all.jars.path}" />
            <pathelement location="${libs.jar.dir}/zxing/zxing.jar" />
        </path>

        <path id="vasdolly.jar.path">
            <path path="${toString:project.all.jars.path}" />
            <pathelement location="${libs.jar.dir}/vasdolly/vasdolly.jar" />
        </path>

        <path id="funshion.jar.path">
            <path path="${toString:project.all.jars.path}" />
            <pathelement location="${funshion.libs.dir}/funshion.jar" />
        </path>

        <path id="recyclerview.jar.path">
            <path path="${toString:project.all.jars.path}" />
            <pathelement location="${libs.jar.dir}/recyclerview/recyclerview-v7.jar" />
        </path>

        <path id="android.internal.sdk.jar.path">
            <path path="${toString:project.target.class.path}" />
            <pathelement location="${libs.jar.dir}/android/android-sdk-internal.jar" />
        </path>

        <path id="support.v4.jar.path">
            <path path="${toString:project.all.jars.path}" />
            <pathelement location="${sdk.dir}/extras/android/support/v7/appcompat/libs/android-support-v4.jar" />
        </path>

        <path id="project.all.jars.path">
            <path refid="zxing.jar.path" />
            <path refid="vasdolly.jar.path" />
            <path refid="funshion.jar.path" />
            <path refid="support.v4.jar.path" />
            <path refid="recyclerview.jar.path" />
        </path>

        <path id="project.target.class.path">
            <path refid="android.internal.sdk.jar.path" />
        </path>

        <echo message="library jars : ${toString:project.target.class.path}" />
        <echo message="program jars : ${toString:project.all.jars.path}" />
    </target>

    <!-- properties for signing -->
    <property name="key.store" value="${basedir}/AuroraKS.keystore" />
    <property name="key.alias" value="aurora" />
    <property name="key.store.password" value="QEDdfx@!34" />
    <property name="key.alias.password" value="lk#$AA78YG" />

    <!-- post-build target -->
    <target name="-post-build">
        <property name="mapping.file.name" value="${ant.project.name}_${version.name}_mapping.txt" />

        <!-- copy mapping file -->
        <echo level="info">Copy mapping file : ${mapping.file.name}</echo>
        <copy file="${out.absolute.dir}/proguard/mapping.txt" tofile="${out.absolute.dir}/${mapping.file.name}" failonerror="false" />

        <!-- clean temp files -->
        <echo level="info">Deletes temp file...</echo>
        <delete includeEmptyDirs="true" verbose="${verbose}">
            <fileset dir="${out.absolute.dir}" excludes="${out.file.name} ${mapping.file.name}" />
        </delete>

        <!-- build channel apk files -->
        <property name="vasdolly.jar.path" value="${libs.jar.dir}/vasdolly/libs/vasdolly.jar" />
        <exec executable="cmd.exe">
            <arg line="/C java -jar ${vasdolly.jar.path} put -c ${basedir}/channel.txt ${out.final.file} ${out.absolute.dir} " />
        </exec>

        <!-- copy the build apk files -->
        <property name="out.final.dir" value="${basedir}/outputs/${version.name}/${out.file.dir}" />
        <mkdir dir="${out.final.dir}" />
        <copy todir="${out.final.dir}" overwrite="true">
            <fileset dir="${out.absolute.dir}" />
        </copy>
    </target>
</project>
